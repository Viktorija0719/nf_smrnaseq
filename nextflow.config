/*
 nextflow.config — RTU PBS + Singularity, smRNA-seq
 --------------------------------------------------
 - Uses PBS executor (no Docker)
 - Ensures Singularity is loaded *inside each task* and host Java is not leaked
 - Binds BeeGFS paths and /tmp into containers
 - Keeps work + cache on BeeGFS
 - Conservative scheduler throttling to avoid spamming PBS
*/

def USER   = System.getenv('USER') ?: 'vikja01'
def BEEGFS = "/home_beegfs/${USER}"
def SING_CACHE = System.getenv('SINGULARITY_CACHEDIR') ?: "${BEEGFS}/.singularity_cache"
def WORKDIR    = System.getenv('NXF_WORK') ?: "${BEEGFS}/.nxf_work"

process {
  executor = 'pbs'
  shell    = ['/bin/bash','-euo','pipefail']

  /*
    If your PBS has node features/props to prefer CentOS7 nodes, uncomment:
    clusterOptions = '-l feature=centos7'
    (Remove if your PBS doesn’t support this.)
  */

  /*
    Prevent flooding the scheduler with too many small jobs at once.
    Tweak if your site allows a higher rate or larger queue.
  */
  submitRateLimit = '15/1s'
  queueSize       = 80

  /*
    Make every task start with a clean module env, load Singularity,
    bind your filesystems, and neutralize host Java. This is the key
    to avoiding JNI/JVM errors from leaking the login JDK into containers.
  */
  beforeScript = """
    source /etc/profile.d/modules.sh
    module purge
    module load singularity/3.11.4

    export SINGULARITY_CACHEDIR='${SING_CACHE}'
    export APPTAINER_CACHEDIR='${SING_CACHE}'
    export NXF_SINGULARITY_CACHEDIR='${SING_CACHE}'
    export SINGULARITY_BINDPATH='/home_beegfs,/mnt/beegfs2,/tmp'
    export APPTAINER_BINDPATH='/home_beegfs,/mnt/beegfs2,/tmp'

    # ensure host Java doesn't leak into containers
    unset JAVA_HOME _JAVA_OPTIONS
    export SINGULARITYENV_JAVA_HOME=''
    export SINGULARITYENV__JAVA_OPTIONS=''
  """

  /*
    If your queues enforce strict per-task limits, you can add gentle caps:
    withLabel:process_low    { cpus = 2; memory = '6 GB';  time = '4h'  }
    withLabel:process_medium { cpus = 4; memory = '12 GB'; time = '8h'  }
    withLabel:process_high   { cpus = 8; memory = '24 GB'; time = '16h' }
  */
}

singularity {
  enabled    = true
  autoMounts = true
  cacheDir   = "${SING_CACHE}"
  // backup bind (env vars already handle it)
  runOptions = '--bind /home_beegfs,/mnt/beegfs2,/tmp'
}

workDir = "${WORKDIR}"

/* Handy defaults (can be overridden on CLI or via env) */
params {
  adapter = 'TGGAATTCTCGGGTGCCAAGG'
  fastp_min_length    = 18
  fastp_max_length    = 30
}

